<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Explainable recommendations user study</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <style>

        table, th, td {
            border: 1px solid black;
        }

        .slidecontainer {
            width: 10%;
        }

        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background-image: linear-gradient(to right, rgba(255, 0, 0, 0.7), rgba(0, 128, 0, 0.7));
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            -webkit-appearance: none;
        }

        .slider:hover {
            background-image: linear-gradient(to right, rgba(255, 0, 0, 1), rgba(0, 128, 0, 1));
        }

        .slider::-webkit-slider-thumb {
            width: 23px;
            height: 24px;
            border: 0;
            background: url('contrasticon.png');
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 23px;
            height: 24px;
            border: 0;
            background: url('contrasticon.png');
            cursor: pointer;
        }
    </style>

    <script>
        function getSearchParameters() {
            var prmstr = window.location.search.substr(1);
            return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
        }

        function transformToAssocArray(prmstr) {
            var params = {};
            var prmarr = prmstr.split("&");
            for (var i = 0; i < prmarr.length; i++) {
                var tmparr = prmarr[i].split("=");
                params[tmparr[0]] = tmparr[1];
            }
            return params;
        }

        let params = getSearchParameters();
        let page = 0
        if (params.p)
            page = params.p

        const myStorage = window.localStorage;

        function broofa() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function initialize_user() {
            let id_from_params = params.user_id
            if (id_from_params) {
                localStorage.setItem('user_id', params.user_id);
            }
            else {
                let id = localStorage.getItem('user_id');
                if (!id) {
                    id = broofa();
                    localStorage.setItem('user_id', id);
                }
            }
            $('#user_info').text('You are the user ' + localStorage.getItem('user_id'));
        }

        function initialize_recommender() {
            let recommender = localStorage.getItem('recommender');
            if (!recommender) {
                localStorage.setItem('recommender', 'bert');
            }
            $('#recommender_info').text('Using recommender ' + recommender);
        }

        function get_page_state() {
            let state = localStorage.getItem('page_state');
            if (!state) {
                state = "reviewing"
                localStorage.setItem('state', state);
            }
            $('#page_state').text('Currently ' + state);
            return state;
        }

        function buildHtmlTable(selector, content, transpose) {
            var columns = addAllColumnHeaders(content, selector);
            $(selector).html('<span></span>');

            for (var i = 0; i < content.length; i++) {
                var row$ = $('<tr/>');
                for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                    var cellValue = content[i][columns[colIndex]];
                    if (cellValue == null) cellValue = "";
                    row$.append($('<td/>').html(cellValue));
                }
                $(selector).append(row$);
            }

            if (transpose) {
                $(selector).each(function () {
                    var $this = $(this);
                    var newrows = [];
                    $this.find("tr").each(function (rowToColIndex) {
                        $(this).find("td, th").each(function (colToRowIndex) {
                            if (newrows[colToRowIndex] === undefined) {
                                newrows[colToRowIndex] = $("<tr></tr>");
                            }
                            while (newrows[colToRowIndex].find("td, th").length < rowToColIndex) {
                                newrows[colToRowIndex].append($("<td></td>"));
                            }
                            newrows[colToRowIndex].append($(this));
                        });
                    });
                    $this.find("tr").remove();
                    $.each(newrows, function () {
                        $this.append(this);
                    });
                });
            }
        }

        // Adds a header row to the table and returns the set of columns.
        // Need to do union of keys from all records as some records may not contain
        // all records.
        function addAllColumnHeaders(content, selector) {
            var columnSet = [];
            var headerTr$ = $('<tr/>');

            for (var i = 0; i < content.length; i++) {
                var rowHash = content[i];
                for (var key in rowHash) {
                    if ($.inArray(key, columnSet) == -1) {
                        columnSet.push(key);
                        headerTr$.append($('<th/>').html(key));
                    }
                }
            }
            $(selector).append(headerTr$);

            return columnSet;
        }

        $(window).on('load', function () {
            initialize_user();
            initialize_recommender();
            let state = get_page_state();
            $.get('/recommend_api?user_id=' + localStorage.getItem('user_id') + '&recommender=' + localStorage.getItem('recommender'),  // url
                function (data, textStatus, jqXHR) {
                    data = jQuery.parseJSON(data);

                    let asin = data['recommendations'][page]['asin'];
                    let explanations = data['recommendations'][page]['explanations'];
                    $('#content_amazon_link').attr('href', 'https://www.amazon.com/dp/' + asin + '/');
                    //$('#explanations').text('' + JSON.stringify(data['recommendations'][page]['explanations']));
                    $('#content_amazon_embed').attr('src', 'https://music.amazon.com/embed/' + asin + '/?id=1KtKydB3pR&marketplaceId=' + asin + '&musicTerritory=US');

                    for (let i = 1; i < 6; i++) {
                        if (data['users_interests'][i]) {
                            let user_interest_str = ''
                            for (let item_key in data['users_interests'][i]) {
                                let item = data['users_interests'][i][item_key];
                                user_interest_str += '\"' + item.join(" ") + '\", ';
                            }
                            $('#users_properties_' + i).append('<h4 style="padding-left: 35px;"> ' + user_interest_str + ' </h4>');
                        } else {
                            $('#users_properties_' + i).text('');
                        }
                    }

                    let item_explanation_str = ''
                    for (let item_key in data['recommendations'][page]['explanations']) {
                        let item = data['recommendations'][page]['explanations'][item_key];

                        item_explanation_str += '' + item['item_feature'].join(" ") + ', ';
                        //item_explanation_str += '\"' + item['item_feature'].join(" ") + '\"';
                        //item_explanation_str += '(' + item['users_matching_interest'].join(" ") + '), ';

                    }

                    $('#explanations').append('<b>' + item_explanation_str + '</b>');


                    $('#next_button').attr('href', '/recommend?p=' + (parseInt(page) + 1));
                    $('#prev_button').attr('href', '/recommend?p=' + (parseInt(page) - 1));

                    $('input#user_id').val(localStorage.getItem('user_id'));
                    $('input#asin').val(asin);
                    $('input#recommender').val(localStorage.getItem('recommender'));

                    let item_metadata_json = jQuery.parseJSON((data['recommendations'][page]['item_metadata']))

                    console.log(item_metadata_json);

                    if (item_metadata_json[0] !== undefined && item_metadata_json[0]['imageURLHighRes'] !== undefined)
                    {
                        for (var i = 0; i < item_metadata_json[0]['imageURLHighRes'].length; i++) {
                            item_metadata_json[0]['imageURLHighRes'][i] = '<img src=' + item_metadata_json[0]['imageURLHighRes'][i] + '>';
                        }

                        buildHtmlTable('#item_metadata', item_metadata_json);
                    }
                });

        });

        function toggleRecommender() {
            let currentRecommender = localStorage.getItem('recommender');
            if (currentRecommender === 'yake_1')
                localStorage.setItem('recommender', 'yake');
            else if (currentRecommender === 'yake')
                localStorage.setItem('recommender', 'bert_1')
            else
                localStorage.setItem('recommender', 'yake_1')
            document.location.reload(true);
        }


    </script>
</head>
<body>

<center><h1>User Study for the Thesis, Explanable Recommendations using extracted topics</h1></center>

<div>
    <div id="recommender_info"></div>
    <button onclick="toggleRecommender()">Switch Recommender</button>

</div>

<br/>
<hr>
<br/>

<div>
    <div id="user_info"></div>
    <button onclick="localStorage.removeItem('user_id');document.location.reload(true);">Reset</button>
</div>

<div>
    <div id="page_state"></div>
    <br/>
    <hr>
    <br/>

    <div id="search">Search
        <form action="search" id="search_form" method="get" target="/">
            <input type="text" name="q" id="search_query">
            <input type="submit" value="Submit">
        </form>
    </div>

    <div hidden id="what_we_know_about_you">
    <br/>
    <hr>
    <br/>


        <center><h2>What we know about you ?!</h2></center>
        <div id="users_properties">
            <span id="users_properties_1">You really don't like</span>
            <span id="users_properties_2">You are not a fan of</span>
            <span id="users_properties_3">You are meeh when you hear</span>
            <span id="users_properties_4">You love to hear about</span>
            <span id="users_properties_5">You are dying for</span>
        </div>
    </div>
    <br/>
    <hr>
    <br/>

    <div id="content">
        <center>
            <h2> Here is what we found for you: </h2>
            <a id="content_amazon_link" href="https://www.amazon.com/dp/xdd">Amazon Marketplace link of the recommended
            item</a>
            <br />
            <br />
            <div id="explanations">
                <i>
                    We thought that you might like the item since the properties of the item are similar to your taste:
                </i>
            </div>
            <br/>
            <br/>
        </center>
        <br/>
        <!--
        <center>
            <iframe id='content_amazon_embed' width='80%' height='350px'
                    style='border:1px solid rgba(0, 0, 0, 0.12);max-width:'></iframe>
        </center/>
        -->
        <div id="item_metadata"></div>
        <br/>
        <br/>




    </div>
    <br/>
    <hr>
    <br/>

    <center>
        <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>

        <div id="recommendations_review">
            <form action="recommendations_review" id="usrform" method="post" target="dummyframe">
                How much did you like the recommended item?
                <div class="slidecontainer">
                    <label for="recommendation_rating"></label><input type="range" min="1" max="100" value="50"
                                                                      class="slider" id="recommendation_rating"
                                                                      name="recommendation_rating">
                </div>
                <br/><br/>
                Independent from the first question, how good the explanation given for that item?
                <div class="slidecontainer">
                    <label for="explanation_rating"></label><input type="range" min="1" max="100" value="50"
                                                                   class="slider" id="explanation_rating"
                                                                   name="explanation_rating">
                </div>
                <br/><br/>

                How authentic do you think the item is?
                <div class="slidecontainer">
                    <label for="authenticity_rating"></label><input type="range" min="1" max="100" value="50"
                                                                      class="slider" id="authenticity_rating"
                                                                      name="authenticity_rating">
                </div>
                <br/><br/>
                <button><a id="prev_button" href="xd">Prev</a></button>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <input type="reset"
                       onclick='document.forms["usrform"].submit();window.history.pushState({}, document.title, "/recommend?p=" + (parseInt(page) + 1)); document.location.reload(true);'
                       value="Submit">
                &nbsp;&nbsp;&nbsp;&nbsp;
                <button><a id="next_button" href="xd">Next</a></button>
                <input type="hidden" value="asin" name="asin" id="asin">
                <input type="hidden" value="user_id" name="user_id" id="user_id">
                <input type="hidden" value="recommender" name="recommender" id="recommender">
            </form>
        </div>
    </center>


</div>


</body>
</html>